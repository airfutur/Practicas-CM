<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>DOOM by CS.Y.CS</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });


function preload() {

    game.load.image('back1', 'assets/back1.png'); //Fondo del primer escenario
    game.load.image('ground', 'assets/ground.png'); //Suelo y plataformas
    // game.load.image('star', 'assets/star.png');
    // game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.load.spritesheet('marine', 'assets/marine.png', 53, 72, 49); // marine
    game.load.spritesheet('imp', 'assets/imp.png', 41, 62, 62); // imp
    game.load.image('bullet', 'assets/bala.png'); //bala

}

var player,imp,fireButton;
var bullets;
var bulletTime=0;
var firingTimer=0;
var combat;
var platforms;
var cursors;
var dir="";


var stars;

function create() {

    //  Habilito el sistema de fisicas arcade
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  Fondo de pantalla del escenario 1
    game.add.sprite(0, 0, 'back1');

    //  Creo el grupo plataformas que tendra el suelo y los dos bordes donde saltar
    platforms = game.add.group();

    // Activo las fisicas paratodo objeto creado en este grupo
    platforms.enableBody = true;

    //  Grupo de balas
    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
    bullets.createMultiple(30, 'bullet');
    bullets.setAll('anchor.x', 0.5);
    bullets.setAll('anchor.y', 1);
    bullets.setAll('outOfBoundsKill', true);
    bullets.setAll('checkWorldBounds', true);

    // Aqui creo el suelo
    var ground = platforms.create(0, game.world.height - 50, 'ground');

    //  Antiguo codigo del ejemplo para escalar objetos (Ya no necesario), lo dejo por si acaso
    // ground.scale.setTo(2, 2);

    //  Hago que el suelo sea un elemento fijo en el juego y no se mueva al tocarlo.
    ground.body.immovable = true;

    //  Ahora creo tres plataformas
    var ledge = platforms.create(400, 400, 'ground');
    ledge.body.immovable = true;

    ledge = platforms.create(-300, 180, 'ground');
    ledge.body.immovable = true;

    ledge = platforms.create(700, 280, 'ground');
    ledge.body.immovable = true;

    // Añadir los sprites al jugador y a los monstruos
    player = game.add.sprite(32, game.world.height - 120, 'marine');
    imp = game.add.sprite(500,game.world.height - 120,'imp');

    //  Hay que activar las fisicas en el jugador y en los monstruos
    game.physics.arcade.enable(player);
    game.physics.arcade.enable(imp);

    //  Aqui fijo las propiedades de la fisica del jugador, como el rebote y la gravedad.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 400;
    player.body.collideWorldBounds = true;

    //Aqui fijo las fisicas de los monstruos
    imp.body.bounce.y = 0.2;
    imp.body.gravity.y = 400;
    imp.body.collideWorldBounds = true;


    //  Declaro las animaciones del jugador y monstruos. Mover a la izquierda, derecha, saltar...
    /* HAY QUE MODIFICARLAS!!! Se quedan en fase "beta" hasta navidad, ya que es un trabajo
     * de photoshop, paciencia e ir probando para que empasten bien y el juego se vea "smooth" */
    player.animations.add('walking', [11,12,13,12], 7, true);
    player.anchor.setTo(.5,.5);
    // player.animations.add('right', [15], 10, true);
    imp.animations.add('left', [3], 10, true);
    // imp.animations.add('right', [15], 10, true); VOLTEAR HORIZONTALMENTE, testearlo y aplicarlo!
    /* CODIGO PARA VOLTEAR HORIZONTALMENTE LOS SPRITES Y QUE NO SEA NECESARIO CARGAR TANTAS IMAGENES:

    // Set Anchor to the center of your sprite

     yourSprite.anchor.setTo(.5,.5);

     // Invert scale.x to flip left/right
        player.scale.x*=-1;
     yourSprite.scale.x *= -1;

     // Invert scale.y to flip up/down

     yourSprite.scale.y *= -1;
    *
    * */

    //  Controles del juego.
    cursors = game.input.keyboard.createCursorKeys();
    fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

    // Aqui creo el HUD con la vida y las balas disponibles. MODIFICAR CON IMAGENES

    var style = { font: "32px Arial", fill: "white", align: "center" };
    vida=100;
    vida_text = game.add.text(game.world.width/2-200, game.world.height-36, "Health: "+vida, style);
    municion=50;
    municion_text = game.add.text(game.world.width/2, game.world.height-36, "Ammunition: "+municion, style);
    
}

function update() {

    //  Colision del jugador, los enemigos y los potenciadores/suministros con el suelo
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(imp, platforms);

    //  Comprobación de si el jugador choca con un imp, en ese caso llama a la función impDamage
    game.physics.arcade.overlap(player, imp, impDamage, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;


    if (cursors.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -200;
        player.scale.x=1;
        player.animations.play('walking');
        dir='move_left';
    }
    else if (cursors.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 200;
        player.scale.x=-1;
        player.animations.play('walking');

        dir='move_right';

    }
    else
    {
        //  Stand still
        player.animations.stop();

        if (dir=='move_left') {
            player.frame = 22;
        }
        else if (dir=='move_right') {
        player.frame = 22;
        }

    }

    if (fireButton.isDown){
        if (municion>0){player.frame = 27;}
        fireBullet();
    }
    
    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down)
    {

        player.body.velocity.y = -350;
    }

}

function fireBullet () {

    //  To avoid them being allowed to fire too fast we set a time limit
    if (game.time.now > bulletTime)
    {
        //  Grab the first bullet we can from the pool
        bullet = bullets.getFirstExists(false);

        if (bullet && (municion>0))
        {
            //  And fire it
            if(dir=="move_left") {
                bullet.scale.x=-1;
                bullet.reset(player.x - 40, player.y + 6);
                bullet.body.velocity.x = -1670;
                bulletTime = game.time.now + 100;
            }
            else {
                bullet.scale.x=1;
                bullet.reset(player.x + 40, player.y + 6);
                bullet.body.velocity.x = 1670;
                bulletTime = game.time.now + 100;
            }
            municion--;
        }
        municion_text.text="Ammunition: "+municion;
    }

}

function impDamage (player, imp) {
    vida-=0.1;
    vida_text.text = "Health: "+vida.toFixed(0);


}

function resetBullet (bullet) {

    //  Called if the bullet goes out of the screen
    bullet.kill();

}

</script>

</body>
</html>